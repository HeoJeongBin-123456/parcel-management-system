<!DOCTYPE html>
<html>
<head>
    <title>검색 알림 버그 수정 테스트</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        #log { background: #f5f5f5; padding: 10px; min-height: 200px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>검색 알림 버그 수정 테스트</h1>

    <div class="test-section">
        <h2>테스트 시나리오</h2>
        <p>아래 버튼을 클릭하여 테스트를 시작하세요:</p>
        <button onclick="runTest()">테스트 실행</button>
        <button onclick="clearLog()">로그 지우기</button>
    </div>

    <div class="test-section">
        <h2>테스트 로그</h2>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<span style="color: ${color}">[${time}] ${message}</span>\n`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function runTest() {
            clearLog();
            log('=== 검색 알림 버그 수정 테스트 시작 ===', 'success');

            // 테스트 1: SearchModeManager 확인
            log('\n1. SearchModeManager 확인...');
            if (window.parent.SearchModeManager) {
                log('✅ SearchModeManager 존재', 'success');

                // 테스트 2: 중복 검색 방지 확인
                log('\n2. 중복 검색 방지 테스트...');

                // alert 오버라이드하여 캡처
                const originalAlert = window.parent.alert;
                let alertCount = 0;
                let alertMessages = [];

                window.parent.alert = function(msg) {
                    alertCount++;
                    alertMessages.push(msg);
                    log(`⚠️ Alert 발생: "${msg}"`, 'error');
                };

                // 검색 실행
                log('검색 실행: "종로구 1-1"');
                await window.parent.SearchModeManager.executeSearch('종로구 1-1', 'all');

                // 잠시 대기
                await new Promise(resolve => setTimeout(resolve, 2000));

                // 결과 확인
                const results = window.parent.SearchModeManager.searchResults;
                log(`\n3. 검색 결과: ${results.length}개 발견`);

                if (alertCount > 0) {
                    log(`\n❌ Alert가 ${alertCount}번 발생했습니다.`, 'error');
                    alertMessages.forEach((msg, idx) => {
                        log(`   Alert ${idx + 1}: ${msg}`, 'error');
                    });
                } else {
                    log('\n✅ Alert가 발생하지 않았습니다!', 'success');
                }

                // alert 복원
                window.parent.alert = originalAlert;

                // 테스트 4: 검색 함수 체크
                log('\n4. 검색 함수 통합 확인...');
                if (window.parent.searchAddress) {
                    const searchAddressStr = window.parent.searchAddress.toString();
                    if (searchAddressStr.includes('SearchModeManager')) {
                        log('✅ searchAddress가 SearchModeManager를 사용합니다', 'success');
                    } else {
                        log('⚠️ searchAddress가 아직 구 버전입니다', 'error');
                    }
                }

            } else {
                log('❌ SearchModeManager를 찾을 수 없습니다', 'error');
            }

            log('\n=== 테스트 완료 ===', 'success');
        }

        // 페이지 로드 후 자동 실행
        window.onload = function() {
            if (window.parent === window) {
                log('⚠️ 이 페이지는 iframe 내에서 실행되어야 합니다.', 'error');
                log('localhost:4000에서 직접 테스트하세요.', 'error');
            } else {
                log('테스트 준비 완료. "테스트 실행" 버튼을 클릭하세요.');
            }
        };
    </script>
</body>
</html>