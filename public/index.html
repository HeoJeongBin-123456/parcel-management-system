<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <title>parcel-management-system</title>
    
    <!-- ë„¤ì´ë²„ ì§€ë„ API - ë¹„ë™ê¸° ë¡œë“©ìœ¼ë¡œ ì„±ëŠ¥ ê°œì„  -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=x21kpuf1v4&submodules=geocoder,panorama" defer></script>
    

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- html2canvas for screenshot capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/advanced-ui.css">
    <link rel="stylesheet" href="/css/business-style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/backup-ui.css">
    <link rel="stylesheet" href="/css/modes.css">
    <link rel="stylesheet" href="/css/google-calendar.css">
</head>
<body>
    <div id="app">
        <!-- í—¤ë” ì˜ì—­ -->
        <header class="header">
            <div class="header-left">
                <div class="brand-text">
                    <h1 class="site-title">í•„ì§€ ê´€ë¦¬ í”„ë¡œê·¸ë¨</h1>
                    <span class="brand-eyebrow">Parcel Management System</span>
                </div>
                <!-- ì§€ë„ íƒ€ì… ì„ íƒ -->
                <div class="map-type-selector map-type-inner">
                    <button class="map-type-btn active" data-type="normal">ì¼ë°˜ì§€ë„</button>
                    <button class="map-type-btn" data-type="satellite">ìœ„ì„±ì§€ë„</button>
                    <button class="map-type-btn" data-type="cadastral">ì§€ì í¸ì§‘ë„</button>
                    <button class="map-type-btn" data-type="street">ê±°ë¦¬ë·°</button>
                </div>
            </div>
            <div class="header-center">
                <!-- ëª¨ë“œ ì „í™˜ ë²„íŠ¼ -->
                <div class="mode-switcher-header">
                    <button class="mode-button active" data-mode="click" data-emoji="ğŸ¯">ğŸ¯ í´ë¦­</button>
                    <button class="mode-button" data-mode="search" data-emoji="ğŸ”">ğŸ” ê²€ìƒ‰</button>
                    <button class="mode-button" data-mode="hand" data-emoji="âœ‹">âœ‹ ì†</button>
                </div>
            </div>
            <div class="header-right">
                <div id="connectionStatus" class="connection-status disconnected">ğŸ”´ ì—°ê²° ì¤‘...</div>
                <button id="logoutBtn" class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
        <div class="main-container">
            <!-- ì‚¬ì´ë“œë°” -->
            <aside class="sidebar">
            <!-- ìƒ‰ìƒ ì„ íƒ íŒ¨ë„ -->
            <div class="color-panel">
                <h3>í•„ì§€ ìƒ‰ìƒ <span class="mode-badge">í´ë¦­ ëª¨ë“œ</span></h3>
                <div class="color-panel-content" id="colorPanelContent">
                    <div class="color-palette" id="colorPalette">
                        <div class="color-item active" data-color="0" data-hex="#FF0000" style="background: #FF0000" title="ë¹¨ê°•"></div>
                        <div class="color-item" data-color="1" data-hex="#FFA500" style="background: #FFA500" title="ì£¼í™©"></div>
                        <div class="color-item" data-color="2" data-hex="#FFFF00" style="background: #FFFF00" title="ë…¸ë‘"></div>
                        <div class="color-item" data-color="3" data-hex="#90EE90" style="background: #90EE90" title="ì—°ë‘"></div>
                        <div class="color-item" data-color="4" data-hex="#0000FF" style="background: #0000FF" title="íŒŒë‘"></div>
                        <div class="color-item" data-color="5" data-hex="#000000" style="background: #000000" title="ê²€ì •"></div>
                        <div class="color-item" data-color="6" data-hex="#FFFFFF" style="background: #FFFFFF; border: 1px solid #ccc" title="í°ìƒ‰"></div>
                        <div class="color-item" data-color="7" data-hex="#87CEEB" style="background: #87CEEB" title="í•˜ëŠ˜ìƒ‰"></div>
                    </div>
                    <div class="current-color">
                        <span>ì„ íƒëœ ìƒ‰ìƒ:</span>
                        <div id="currentColor" style="background: #FF0000"></div>
                    </div>
                    <div class="color-stats">
                        <span id="colorStats">ì´ 0ê°œ í•„ì§€</span>
                    </div>
                </div>
                <div class="color-panel-placeholder" id="colorPanelPlaceholder" style="display: none;">
                    <div class="placeholder-text">ìƒ‰ìƒ ì‘ì—…ì€ í´ë¦­ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    <button type="button" id="colorPanelSwitchBtn" class="btn-switch-mode">í´ë¦­ ëª¨ë“œë¡œ ì „í™˜</button>
                </div>
            </div>

            <!-- í•„ì§€ ì •ë³´ ì…ë ¥ -->
            <div class="parcel-info">
                <h3>í•„ì§€ ì •ë³´</h3>
                <form id="parcelForm" class="parcel-form">
                    <div class="form-group">
                        <label>ì§€ë²ˆ</label>
                        <input type="text" id="parcelNumber" placeholder="ì˜ˆ: 123-4">
                    </div>
                    <div class="form-group">
                        <label>ì†Œìœ ì ì´ë¦„</label>
                        <input type="text" id="ownerName" placeholder="í™ê¸¸ë™">
                    </div>
                    <div class="form-group">
                        <label>ì†Œìœ ì ì£¼ì†Œ</label>
                        <input type="text" id="ownerAddress" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬...">
                    </div>
                    <div class="form-group">
                        <label>ì—°ë½ì²˜</label>
                        <input type="text" id="ownerContact" placeholder="010-1234-5678">
                    </div>
                    <div class="form-group form-group-wide">
                        <label>ë©”ëª¨</label>
                        <textarea id="memo" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨..." style="resize: vertical; min-height: 52px; max-height: 120px;"></textarea>
                    </div>
                    <div class="form-actions form-actions-wide">
                        <div class="form-actions-primary">
                            <button type="button" id="saveParcelInfoBtn" class="btn-save">ì €ì¥</button>
                            <button type="button" id="deleteParcelInfoBtn" class="btn-delete">ì‚­ì œ</button>
                            <button type="button" id="copyToClipboardBtn" class="btn-copy">ë³µì‚¬</button>
                        </div>
                    </div>
                </form>
            </div>


            </aside>

            <!-- ì§€ë„ ì˜ì—­ -->
            <div class="map-container">
                <div class="map-floating-actions">
                    <button type="button" id="backupBtn" class="floating-action-btn" onclick="showBackupModal()">
                        ğŸ’¾ ë°±ì—…
                    </button>
                    <button type="button" id="calendarBtn" class="floating-action-btn">
                        ğŸ“… ìº˜ë¦°ë”
                    </button>
                </div>
                <!-- ëª¨ë“œ ì¸ë””ì¼€ì´í„° ì œê±°ë¨ -->

                <!-- ê²€ìƒ‰ ì…ë ¥ (ê²€ìƒ‰ ëª¨ë“œ ì „ìš©) -->
                <div class="search-input-container search-only" style="display:none;">
                    <input type="text" id="searchInput" placeholder="ì§€ë²ˆ ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰">
                    <button id="searchBtn">ê²€ìƒ‰</button>
                </div>

                <!-- ê²€ìƒ‰ ê²°ê³¼ (ì œê±°ë¨ - ì‚¬ìš©ì ìš”ì²­) -->
                <!-- <div class="search-results-container search-only" style="display:none;">
                    <div class="search-results-header">ê²€ìƒ‰ ê²°ê³¼</div>
                    <div id="searchResults" class="search-results-body"></div>
                </div> -->

                <!-- ëª¨ë“œë³„ ë…ë¦½ ì§€ë„ ì¸ìŠ¤í„´ìŠ¤ -->
                <div id="map-click" class="map-instance active"></div>
                <div id="map-search" class="map-instance" style="display:none;"></div>
                <div id="map-hand" class="map-instance" style="display:none;"></div>

                <!-- ê±°ë¦¬ë·° (ëª¨ë“  ëª¨ë“œ ê³µìš©) -->
                <div id="pano" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- êµ¬ê¸€ ìº˜ë¦°ë” ì‚¬ì´ë“œë°” (google-calendar.jsì—ì„œ ë™ì  ìƒì„±) -->
    <!-- ì‚¬ì´ë“œë°”ëŠ” google-calendar.jsì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->

    <!-- ëª¨ë‹¬ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>
    
    

    <!-- JavaScript -->
    <script src="/js/log-config.js"></script>
    <!-- ìµœì í™” ì„¤ì • ì‹œìŠ¤í…œ (ê°€ì¥ ë¨¼ì € ë¡œë“œ) -->
    <script src="/js/optimization-config.js"></script>
    <script src="/js/config-client.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/supabase-config.js"></script>
    <script src="/js/supabase-adapter.js"></script>
    <script src="/js/realtime-sync.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/map.js"></script>
    <script src="/js/mode-click-handler.js"></script>
    <script src="/js/mode-search-handler.js"></script>
    <script src="/js/map-instances.js"></script>
    <script src="/js/polygon-optimizer.js"></script>
    <script src="/js/map-performance-monitor.js"></script>
    <!-- í•„ì§€ ê²€ì¦ ìœ í‹¸ë¦¬í‹° (ìµœìš°ì„  ë¡œë“œ - ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ ì‚¬ìš©) -->
    <script src="/js/parcel-validation-utils.js"></script>
    <!-- ë¹ˆ í•„ì§€ ì •ë¦¬ ë„êµ¬ (ê°œë°œì ë„êµ¬ì—ì„œ ìˆ˜ë™ ì‹¤í–‰) -->
    <script src="/js/cleanup-empty-parcels.js"></script>
    <!-- ìƒˆë¡œìš´ í†µí•© ë°±ì—… ë° ì‹¤ì‹œê°„ í˜‘ì—… ì‹œìŠ¤í…œ (parcel.jsë³´ë‹¤ ë¨¼ì € ë¡œë“œ) -->
    <script src="/js/unified-backup-manager.js"></script>
    <script src="/js/realtime-collaboration.js"></script>
    <script src="/js/parcel.js"></script>
    <script src="/js/parcel-manager.js"></script>
    <script src="/js/mode-manager.js"></script>
    <script src="/js/color-palette.js"></script>
    <script src="/js/search-mode.js"></script>
    <script src="/js/search.js"></script>
    <script src="/js/memo-markers.js"></script>
    <script src="/js/mobile-handler.js"></script>
    <!-- data-persistence-manager.js ë¹„í™œì„±í™” - LocalStorageì™€ Supabaseë§Œ ì‚¬ìš© -->
    <!-- <script src="/js/data-persistence-manager.js"></script> -->
    <script src="/js/parcel-restore-helper.js"></script>
    <!-- ê¸°ì¡´ ë°±ì—… ì‹œìŠ¤í…œ ì œê±° (unified-backup-manager.jsë¡œ í†µí•©) -->
    <!-- <script src="/js/backup-manager.js"></script> -->
    <!-- <script src="/js/advanced-backup-manager.js"></script> -->
    <!-- <script src="/js/backup-ui.js"></script> -->
    <script src="/js/realtime-autosave.js"></script>
    <script src="/js/debug-save-system.js"></script>
    <script src="/js/app-init.js"></script>
    <script src="/js/google-calendar.js"></script>
    <script>
        // ëª¨ë“œ ì „í™˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', function() {
            // ëª¨ë“œ ì „í™˜ ë²„íŠ¼
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.mode;

                    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
                    modeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // ëª¨ë“œ ì „í™˜
                    if (window.ModeManager) {
                        window.ModeManager.switchMode(mode);
                    }
                });
            });

            // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ìë™ ëª¨ë“œ ì „í™˜
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');

            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    const query = searchInput.value.trim();
                    if (query && window.SearchModeManager) {
                        window.SearchModeManager.executeSearch(query, 'all');
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const query = this.value.trim();
                        if (query && window.SearchModeManager) {
                            window.SearchModeManager.executeSearch(query, 'all');
                        }
                    }
                });
            }

            // ê²€ìƒ‰ ì´ˆê¸°í™” ë²„íŠ¼
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    if (window.SearchModeManager) {
                        window.SearchModeManager.clearSearch();
                    }
                });
            }

            // ìƒ‰ìƒ íŒ¨ë„ ì „í™˜ ë²„íŠ¼
            const colorSwitchBtn = document.getElementById('colorPanelSwitchBtn');
            if (colorSwitchBtn) {
                colorSwitchBtn.addEventListener('click', function() {
                    if (window.ModeManager) {
                        window.ModeManager.switchMode('click');
                    }
                });
            }

            // ëª¨ë“œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            window.addEventListener('modeChanged', function(e) {
                const { currentMode } = e.detail;

                // ê²€ìƒ‰ ëª¨ë“œ ì¸ë””ì¼€ì´í„° í‘œì‹œ/ìˆ¨ê¹€
                const searchIndicator = document.querySelector('.search-mode-indicator');
                if (searchIndicator) {
                    searchIndicator.style.display = currentMode === 'search' ? 'flex' : 'none';
                }

                // ìƒ‰ìƒ íŒ¨ë„ ëª¨ë“œ í‘œì‹œ
                const modeBadge = document.querySelector('.mode-badge');
                if (modeBadge) {
                    if (currentMode === 'click') {
                        modeBadge.textContent = 'í´ë¦­ ëª¨ë“œ';
                        modeBadge.style.display = 'inline-block';
                    } else {
                        modeBadge.style.display = 'none';
                    }
                }
            });
        });
    </script>

    <!-- ë°±ì—…/ë³µì› ëª¨ë‹¬ -->
    <div id="backupModal" class="modal" style="display: none;">
        <div class="modal-content backup-restore-modal">
            <div class="modal-header">
                <h2>ë°±ì—… ë° ë³µì› ê´€ë¦¬</h2>
                <span class="close" onclick="closeBackupModal()">&times;</span>
            </div>

            <!-- íƒ­ ë©”ë‰´ -->
            <div class="backup-tabs">
                <button class="backup-tab active" onclick="switchBackupTab('backup')">
                    ğŸ’¾ ë°±ì—…
                </button>
                <button class="backup-tab" onclick="switchBackupTab('restore')">
                    ğŸ”„ ë³µì›
                </button>
            </div>

            <!-- ë°±ì—… íƒ­ ë‚´ìš© -->
            <div id="backupTabContent" class="tab-content active">
                <div class="modal-body">
                    <div class="backup-modal-actions">
                        <button onclick="runManualBackup()" class="backup-action-btn">
                            ğŸ’¾ Excel ë°±ì—… ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                    <hr style="margin: 20px 0;">
                    <h3>ë°±ì—… ëª©ë¡</h3>
                    <div id="backupList">
                        <!-- ë°±ì—… ëª©ë¡ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <!-- ë³µì› íƒ­ ë‚´ìš© (NEW!) -->
            <div id="restoreTabContent" class="tab-content">
                <div class="modal-body">
                    <!-- ë³µì› ê°€ì´ë“œ -->
                    <div class="restore-guide">
                        <h3>ğŸ“– ë³µì› ë°©ë²• (ê°„ë‹¨ 3ë‹¨ê³„)</h3>
                        <div class="guide-steps">
                            <div class="guide-step">
                                <div class="guide-step-number">1</div>
                                <div class="guide-step-content">
                                    <strong>ë°±ì—… íŒŒì¼ ì¤€ë¹„</strong>
                                    <p>ë°±ì—… íƒ­ì—ì„œ ë‹¤ìš´ë¡œë“œí•œ Excel íŒŒì¼ (.xlsx)</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <div class="guide-step-number">2</div>
                                <div class="guide-step-content">
                                    <strong>íŒŒì¼ ì„ íƒ</strong>
                                    <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ì˜¬ë¦¬ì„¸ìš”</p>
                                </div>
                            </div>
                            <div class="guide-step">
                                <div class="guide-step-number">3</div>
                                <div class="guide-step-content">
                                    <strong>ë³µì› ì‹œì‘</strong>
                                    <p>ë¯¸ë¦¬ë³´ê¸° í™•ì¸ í›„ "ë³µì› ì‹œì‘" ë²„íŠ¼ í´ë¦­</p>
                                </div>
                            </div>
                        </div>

                        <div class="safety-notice">
                            <strong>âš ï¸ ì•ˆì „ ë³´ì¥</strong>
                            <p>
                                âœ… ë³µì› ì „ í˜„ì¬ ë°ì´í„° ìë™ ë°±ì—…<br>
                                âœ… ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì´ì „ ìƒíƒœë¡œ ë˜ëŒë¦¼<br>
                                âœ… ë¹ˆ í•„ì§€ëŠ” ìë™ìœ¼ë¡œ ì œê±°ë¨<br>
                                âœ… ìœ íš¨í•œ í•„ì§€ë§Œ ì•ˆì „í•˜ê²Œ ë³µì›
                            </p>
                        </div>
                    </div>

                    <hr style="margin: 20px 0;">

                    <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
                    <div class="file-upload-area" id="fileUploadArea">
                        <input type="file" id="restoreFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                        <div class="upload-zone" onclick="document.getElementById('restoreFileInput').click()">
                            <div class="upload-icon">ğŸ“</div>
                            <p class="upload-text">í´ë¦­í•˜ê±°ë‚˜ Excel íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                            <small class="upload-hint">.xlsx ë˜ëŠ” .xls íŒŒì¼ë§Œ ê°€ëŠ¥</small>
                        </div>
                    </div>

                    <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                    <div id="restorePreview" class="restore-preview" style="display: none;">
                        <h3>ğŸ“Š ë³µì› ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
                        <div class="preview-stats">
                            <div class="stat-item">
                                <span class="stat-label">ì´ í•„ì§€</span>
                                <span class="stat-value" id="previewTotal">0</span>
                            </div>
                            <div class="stat-item stat-valid">
                                <span class="stat-label">âœ… ìœ íš¨í•œ í•„ì§€</span>
                                <span class="stat-value" id="previewValid">0</span>
                            </div>
                            <div class="stat-item stat-invalid">
                                <span class="stat-label">âŒ ë¬´íš¨í•œ í•„ì§€</span>
                                <span class="stat-value" id="previewInvalid">0</span>
                            </div>
                        </div>

                        <div id="previewMessage" class="preview-message"></div>

                        <div class="restore-actions">
                            <button onclick="cancelRestore()" class="btn-secondary">
                                ì·¨ì†Œ
                            </button>
                            <button onclick="startRestore()" class="btn-primary" id="startRestoreBtn">
                                ğŸ”„ ë³µì› ì‹œì‘
                            </button>
                        </div>
                    </div>

                    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
                    <div id="restoreProgressContainer" class="restore-progress" style="display: none;">
                        <h3>ğŸ”„ ë³µì› ì§„í–‰ ì¤‘...</h3>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="restoreProgressBar" style="width: 0%;"></div>
                        </div>
                        <p class="progress-text" id="progressText">0 / 0 (0%)</p>
                        <small class="progress-hint">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ë³µì›ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë°±ì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showBackupModal() {
            document.getElementById('backupModal').style.display = 'block';
            loadBackupList();
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        // ìˆ˜ë™ ë°±ì—… ì‹¤í–‰ (Excel ë‹¤ìš´ë¡œë“œ)
        async function runManualBackup() {
            if (confirm('Excel íŒŒì¼ë¡œ ë°±ì—…ì„ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    if (window.UnifiedBackupManager) {
                        await window.UnifiedBackupManager.downloadExcel();
                    } else {
                        alert('ë°±ì—… ë§¤ë‹ˆì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ë°±ì—… ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('ë°±ì—… ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // TODO(human)
        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ğŸ¯ í˜„ì¬ ì„¸ì…˜ ID ì €ì¥ (ì¬ë¡œê·¸ì¸ ì‹œ ë°ì´í„° ë³µì›ìš©)
                const currentSession = localStorage.getItem('user_session');
                if (currentSession) {
                    localStorage.setItem('last_user_session', currentSession);
                    console.log('âœ… í˜„ì¬ ì„¸ì…˜ ID ì €ì¥:', currentSession);
                }

                // ì„¸ì…˜ ì •ë³´ ì‚­ì œ
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userInfo');
                localStorage.removeItem('authProvider');
                localStorage.removeItem('loginToken');
                localStorage.removeItem('tokenExpiry');
                localStorage.removeItem('devLoginToken');
                localStorage.removeItem('devLoginExpiry');

                // êµ¬ê¸€ ê´€ë ¨ í† í°ë„ ì •ë¦¬ (ìˆì„ ê²½ìš°)
                localStorage.removeItem('googleToken');
                localStorage.removeItem('accessToken');

                // âš ï¸ í•„ì§€ ë°ì´í„°ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ (ì¬ë¡œê·¸ì¸ ì‹œ ë³µì›)
                // localStorage.removeItem('parcelData'); // ì‚­ì œ ì•ˆí•¨
                // localStorage.removeItem('parcelColors'); // ì‚­ì œ ì•ˆí•¨

                console.log('ğŸ” ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ - í•„ì§€ ë°ì´í„°ëŠ” ë³´ì¡´ë¨');

                // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = '/login.html';
            }
        }

        async function loadBackupList() {
            const listContainer = document.getElementById('backupList');

            // ìƒˆë¡œìš´ ë°±ì—… ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ
            const status = window.UnifiedBackupManager?.getStatus();

            let html = '<div class="backup-status">';
            html += '<h4>ë°±ì—… ì‹œìŠ¤í…œ ìƒíƒœ</h4>';
            html += `<p>ğŸŒ ì˜¨ë¼ì¸: ${status?.isOnline ? 'âœ…' : 'âŒ'}</p>`;
            html += `<p>â˜ï¸ Supabase: ${status?.supabaseConnected ? 'âœ… ì—°ê²°ë¨' : 'âŒ ì—°ê²° ì•ˆë¨'}</p>`;

            if (status?.cache) {
                const cacheAge = Math.floor((Date.now() - status.cache.timestamp) / 1000 / 60);
                html += `<p>ğŸ’¾ ë¡œì»¬ ìºì‹œ: ${status.cache.count}ê°œ í•„ì§€ (${cacheAge}ë¶„ ì „)</p>`;
            }

            if (status?.pendingSyncCount > 0) {
                html += `<p>â³ ë™ê¸°í™” ëŒ€ê¸°: ${status.pendingSyncCount}ê°œ</p>`;
            }

            html += '</div>';
            html += '<hr style="margin: 20px 0;">';
            html += '<h4>ë°±ì—… ì•ˆë‚´</h4>';
            html += '<ul style="text-align: left; padding-left: 20px;">';
            html += '<li>â˜ï¸ <strong>ìë™ ë°±ì—…:</strong> ë§¤ì¼ ìƒˆë²½ 2ì‹œ Supabase Storageì— ìë™ ì €ì¥</li>';
            html += '<li>ğŸ“¥ <strong>ìˆ˜ë™ ë°±ì—…:</strong> ìœ„ "ìˆ˜ë™ ë°±ì—… ì‹¤í–‰" ë²„íŠ¼ìœ¼ë¡œ Excel ë‹¤ìš´ë¡œë“œ</li>';
            html += '<li>ğŸ’¾ <strong>ì‹¤ì‹œê°„ ì €ì¥:</strong> ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ Supabaseì— ì¦‰ì‹œ ì €ì¥ë¨</li>';
            html += '<li>ğŸ‘¥ <strong>íŒ€ í˜‘ì—…:</strong> ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë³€ê²½ì‚¬í•­ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë¨</li>';
            html += '</ul>';

            listContainer.innerHTML = html;
        }

        let currentValidationResult = null;

        function switchBackupTab(tabName) {
            const backupTab = document.querySelector('.backup-tab:nth-child(1)');
            const restoreTab = document.querySelector('.backup-tab:nth-child(2)');
            const backupContent = document.getElementById('backupTabContent');
            const restoreContent = document.getElementById('restoreTabContent');

            if (tabName === 'backup') {
                backupTab.classList.add('active');
                restoreTab.classList.remove('active');
                backupContent.classList.add('active');
                restoreContent.classList.remove('active');
                loadBackupList();
            } else {
                backupTab.classList.remove('active');
                restoreTab.classList.add('active');
                backupContent.classList.remove('active');
                restoreContent.classList.add('active');
                setupDragAndDrop();
            }
        }

        function setupDragAndDrop() {
            const uploadZone = document.querySelector('.upload-zone');
            if (!uploadZone) return;

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#667eea';
                uploadZone.style.background = 'rgba(102, 126, 234, 0.05)';
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#ccc';
                uploadZone.style.background = '';
            });

            uploadZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#ccc';
                uploadZone.style.background = '';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    await handleFileUpload(files[0]);
                }
            });
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                await handleFileUpload(file);
            }
        }

        async function handleFileUpload(file) {
            try {
                console.log('ğŸ“ íŒŒì¼ ì„ íƒë¨:', file.name);
                document.querySelector('.upload-text').textContent = 'íŒŒì¼ ë¶„ì„ ì¤‘...';

                const validation = await window.UnifiedBackupManager.uploadExcel(file);

                currentValidationResult = validation;

                showPreview(validation);

            } catch (error) {
                console.error('âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                alert(`íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                resetUploadUI();
            }
        }

        function showPreview(validation) {
            document.getElementById('fileUploadArea').style.display = 'none';
            document.getElementById('restorePreview').style.display = 'block';

            document.getElementById('previewTotal').textContent = validation.total;
            document.getElementById('previewValid').textContent = validation.valid;
            document.getElementById('previewInvalid').textContent = validation.invalid;

            const messageEl = document.getElementById('previewMessage');
            if (validation.isValid) {
                messageEl.innerHTML = `
                    <p class="success-message">âœ… ë³µì› ê°€ëŠ¥í•œ ë°ì´í„°ì…ë‹ˆë‹¤!</p>
                    <p>ìœ íš¨í•œ í•„ì§€ ${validation.valid}ê°œë¥¼ ë³µì›í•©ë‹ˆë‹¤.</p>
                    ${validation.invalid > 0 ? `<p class="warning-text">âš ï¸ ${validation.invalid}ê°œì˜ ë¬´íš¨í•œ í•„ì§€ëŠ” ì œì™¸ë©ë‹ˆë‹¤.</p>` : ''}
                `;
                document.getElementById('startRestoreBtn').disabled = false;
            } else {
                messageEl.innerHTML = `
                    <p class="error-message">âŒ ${validation.error}</p>
                `;
                document.getElementById('startRestoreBtn').disabled = true;
            }
        }

        function cancelRestore() {
            currentValidationResult = null;
            resetUploadUI();
        }

        function resetUploadUI() {
            document.getElementById('fileUploadArea').style.display = 'block';
            document.getElementById('restorePreview').style.display = 'none';
            document.getElementById('restoreProgressContainer').style.display = 'none';
            document.querySelector('.upload-text').textContent = 'í´ë¦­í•˜ê±°ë‚˜ Excel íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”';
            document.getElementById('restoreFileInput').value = '';
        }

        async function startRestore() {
            if (!currentValidationResult || !currentValidationResult.isValid) {
                alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm(`âš ï¸ ì¤‘ìš”: ë³µì›ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìœ íš¨í•œ í•„ì§€ ${currentValidationResult.valid}ê°œë¥¼ ë³µì›í•©ë‹ˆë‹¤.\në³µì› ì „ í˜„ì¬ ë°ì´í„°ëŠ” ìë™ìœ¼ë¡œ ë°±ì—…ë©ë‹ˆë‹¤.`)) {
                return;
            }

            try {
                document.getElementById('restorePreview').style.display = 'none';
                document.getElementById('restoreProgressContainer').style.display = 'block';

                const result = await window.UnifiedBackupManager.restoreFromExcel(currentValidationResult, {
                    showProgress: true,
                    createBackup: true
                });

                document.getElementById('restoreProgressContainer').style.display = 'none';

                alert(`âœ… ë³µì› ì™„ë£Œ!\n\në³µì›ëœ í•„ì§€: ${result.restored}ê°œ\nì œì™¸ëœ í•„ì§€: ${result.skipped}ê°œ`);

                if (confirm('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³µì›ëœ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.reload();
                } else {
                    closeBackupModal();
                }

            } catch (error) {
                console.error('âŒ ë³µì› ì‹¤íŒ¨:', error);
                document.getElementById('restoreProgressContainer').style.display = 'none';
                alert(`âŒ ë³µì› ì‹¤íŒ¨: ${error.message}\n\nì´ì „ ìƒíƒœë¡œ ìë™ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                resetUploadUI();
            }
        }

        async function restoreBackup(backupDate) {
            switchBackupTab('restore');
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('backupModal');
            if (event.target === modal) {
                closeBackupModal();
            }
        }
    </script>

</body>
</html>
