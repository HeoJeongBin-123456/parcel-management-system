<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <title>parcel-management-system</title>
    
    <!-- 네이버 지도 API - 비동기 로듩으로 성능 개선 -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=x21kpuf1v4&submodules=geocoder,panorama" defer></script>
    

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- html2canvas for screenshot capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/advanced-ui.css">
    <link rel="stylesheet" href="/css/business-style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/backup-ui.css">
    <link rel="stylesheet" href="/css/modes.css">
    <link rel="stylesheet" href="/css/google-calendar.css">
</head>
<body>
    <div id="app">
        <!-- 헤더 영역 -->
        <header class="header">
            <div class="header-left">
                <div class="brand-text">
                    <h1 class="site-title">필지 관리 프로그램</h1>
                    <span class="brand-eyebrow">Parcel Management System</span>
                </div>
                <!-- 지도 타입 선택 -->
                <div class="map-type-selector map-type-inner">
                    <button class="map-type-btn active" data-type="normal">일반지도</button>
                    <button class="map-type-btn" data-type="satellite">위성지도</button>
                    <button class="map-type-btn" data-type="cadastral">지적편집도</button>
                    <button class="map-type-btn" data-type="street">거리뷰</button>
                </div>
            </div>
            <div class="header-center">
                <!-- 모드 전환 버튼 -->
                <div class="mode-switcher-header">
                    <button class="mode-button active" data-mode="click" data-emoji="🎯">🎯 클릭</button>
                    <button class="mode-button" data-mode="search" data-emoji="🔍">🔍 검색</button>
                    <button class="mode-button" data-mode="hand" data-emoji="✋">✋ 손</button>
                </div>
            </div>
            <div class="header-right">
                <div id="connectionStatus" class="connection-status disconnected">🔴 연결 중...</div>
                <button id="logoutBtn" class="logout-btn" onclick="handleLogout()">로그아웃</button>
            </div>
        </header>

        <!-- 메인 컨테이너 -->
        <div class="main-container">
            <!-- 사이드바 -->
            <aside class="sidebar">
            <!-- 색상 선택 패널 -->
            <div class="color-panel">
                <h3>필지 색상 <span class="mode-badge">클릭 모드</span></h3>
                <div class="color-panel-content" id="colorPanelContent">
                    <div class="color-palette" id="colorPalette">
                        <div class="color-item active" data-color="0" data-hex="#FF0000" style="background: #FF0000" title="빨강"></div>
                        <div class="color-item" data-color="1" data-hex="#FFA500" style="background: #FFA500" title="주황"></div>
                        <div class="color-item" data-color="2" data-hex="#FFFF00" style="background: #FFFF00" title="노랑"></div>
                        <div class="color-item" data-color="3" data-hex="#90EE90" style="background: #90EE90" title="연두"></div>
                        <div class="color-item" data-color="4" data-hex="#0000FF" style="background: #0000FF" title="파랑"></div>
                        <div class="color-item" data-color="5" data-hex="#000000" style="background: #000000" title="검정"></div>
                        <div class="color-item" data-color="6" data-hex="#FFFFFF" style="background: #FFFFFF; border: 1px solid #ccc" title="흰색"></div>
                        <div class="color-item" data-color="7" data-hex="#87CEEB" style="background: #87CEEB" title="하늘색"></div>
                    </div>
                    <div class="current-color">
                        <span>선택된 색상:</span>
                        <div id="currentColor" style="background: #FF0000"></div>
                    </div>
                    <div class="color-stats">
                        <span id="colorStats">총 0개 필지</span>
                    </div>
                </div>
                <div class="color-panel-placeholder" id="colorPanelPlaceholder" style="display: none;">
                    <div class="placeholder-text">색상 작업은 클릭 모드에서만 사용할 수 있습니다.</div>
                    <button type="button" id="colorPanelSwitchBtn" class="btn-switch-mode">클릭 모드로 전환</button>
                </div>
            </div>

            <!-- 필지 정보 입력 -->
            <div class="parcel-info">
                <h3>필지 정보</h3>
                <form id="parcelForm" class="parcel-form">
                    <div class="form-group">
                        <label>지번</label>
                        <input type="text" id="parcelNumber" placeholder="예: 123-4">
                    </div>
                    <div class="form-group">
                        <label>소유자 이름</label>
                        <input type="text" id="ownerName" placeholder="홍길동">
                    </div>
                    <div class="form-group">
                        <label>소유자 주소</label>
                        <input type="text" id="ownerAddress" placeholder="서울시 강남구...">
                    </div>
                    <div class="form-group">
                        <label>연락처</label>
                        <input type="text" id="ownerContact" placeholder="010-1234-5678">
                    </div>
                    <div class="form-group form-group-wide">
                        <label>메모</label>
                        <textarea id="memo" rows="3" placeholder="추가 메모..." style="resize: vertical; min-height: 52px; max-height: 120px;"></textarea>
                    </div>
                    <div class="form-actions form-actions-wide">
                        <div class="form-actions-primary">
                            <button type="button" id="saveParcelInfoBtn" class="btn-save">저장</button>
                            <button type="button" id="deleteParcelInfoBtn" class="btn-delete">삭제</button>
                            <button type="button" id="copyToClipboardBtn" class="btn-copy">복사</button>
                        </div>
                    </div>
                </form>
            </div>


            </aside>

            <!-- 지도 영역 -->
            <div class="map-container">
                <div class="map-floating-actions">
                    <button type="button" id="backupBtn" class="floating-action-btn" onclick="showBackupModal()">
                        💾 백업
                    </button>
                    <button type="button" id="calendarBtn" class="floating-action-btn">
                        📅 캘린더
                    </button>
                </div>
                <!-- 모드 인디케이터 제거됨 -->

                <!-- 검색 입력 (검색 모드 전용) -->
                <div class="search-input-container search-only" style="display:none;">
                    <input type="text" id="searchInput" placeholder="지번 또는 주소 검색">
                    <button id="searchBtn">검색</button>
                </div>

                <!-- 검색 결과 (제거됨 - 사용자 요청) -->
                <!-- <div class="search-results-container search-only" style="display:none;">
                    <div class="search-results-header">검색 결과</div>
                    <div id="searchResults" class="search-results-body"></div>
                </div> -->

                <!-- 모드별 독립 지도 인스턴스 -->
                <div id="map-click" class="map-instance active"></div>
                <div id="map-search" class="map-instance" style="display:none;"></div>
                <div id="map-hand" class="map-instance" style="display:none;"></div>

                <!-- 거리뷰 (모든 모드 공용) -->
                <div id="pano" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- 구글 캘린더 사이드바 (google-calendar.js에서 동적 생성) -->
    <!-- 사이드바는 google-calendar.js에서 자동으로 생성됩니다 -->

    <!-- 모달 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>
    
    

    <!-- JavaScript -->
    <script src="/js/log-config.js"></script>
    <script src="/js/config-client.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/supabase-config.js"></script>
    <script src="/js/supabase-adapter.js"></script>
    <script src="/js/realtime-sync.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/map.js"></script>
    <script src="/js/mode-click-handler.js"></script>
    <script src="/js/mode-search-handler.js"></script>
    <script src="/js/map-instances.js"></script>
    <script src="/js/polygon-optimizer.js"></script>
    <script src="/js/map-performance-monitor.js"></script>
    <!-- 필지 검증 유틸리티 (최우선 로드 - 다른 모듈에서 사용) -->
    <script src="/js/parcel-validation-utils.js"></script>
    <!-- 빈 필지 정리 도구 (개발자 도구에서 수동 실행) -->
    <script src="/js/cleanup-empty-parcels.js"></script>
    <!-- 새로운 통합 백업 및 실시간 협업 시스템 (parcel.js보다 먼저 로드) -->
    <script src="/js/unified-backup-manager.js"></script>
    <script src="/js/realtime-collaboration.js"></script>
    <script src="/js/parcel.js"></script>
    <script src="/js/parcel-manager.js"></script>
    <script src="/js/mode-manager.js"></script>
    <script src="/js/color-palette.js"></script>
    <script src="/js/search-mode.js"></script>
    <script src="/js/search.js"></script>
    <script src="/js/memo-markers.js"></script>
    <script src="/js/mobile-handler.js"></script>
    <!-- data-persistence-manager.js 비활성화 - LocalStorage와 Supabase만 사용 -->
    <!-- <script src="/js/data-persistence-manager.js"></script> -->
    <script src="/js/parcel-restore-helper.js"></script>
    <!-- 기존 백업 시스템 제거 (unified-backup-manager.js로 통합) -->
    <!-- <script src="/js/backup-manager.js"></script> -->
    <!-- <script src="/js/advanced-backup-manager.js"></script> -->
    <!-- <script src="/js/backup-ui.js"></script> -->
    <script src="/js/realtime-autosave.js"></script>
    <script src="/js/debug-save-system.js"></script>
    <script src="/js/app-init.js"></script>
    <script src="/js/google-calendar.js"></script>
    <script>
        // 모드 전환 버튼 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            // 모드 전환 버튼
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.mode;

                    // 버튼 활성화 상태 변경
                    modeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 모드 전환
                    if (window.ModeManager) {
                        window.ModeManager.switchMode(mode);
                    }
                });
            });

            // 검색 버튼 클릭 시 자동 모드 전환
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');

            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    const query = searchInput.value.trim();
                    if (query && window.SearchModeManager) {
                        window.SearchModeManager.executeSearch(query, 'all');
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const query = this.value.trim();
                        if (query && window.SearchModeManager) {
                            window.SearchModeManager.executeSearch(query, 'all');
                        }
                    }
                });
            }

            // 검색 초기화 버튼
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    if (window.SearchModeManager) {
                        window.SearchModeManager.clearSearch();
                    }
                });
            }

            // 색상 패널 전환 버튼
            const colorSwitchBtn = document.getElementById('colorPanelSwitchBtn');
            if (colorSwitchBtn) {
                colorSwitchBtn.addEventListener('click', function() {
                    if (window.ModeManager) {
                        window.ModeManager.switchMode('click');
                    }
                });
            }

            // 모드 변경 이벤트 리스너
            window.addEventListener('modeChanged', function(e) {
                const { currentMode } = e.detail;

                // 검색 모드 인디케이터 표시/숨김
                const searchIndicator = document.querySelector('.search-mode-indicator');
                if (searchIndicator) {
                    searchIndicator.style.display = currentMode === 'search' ? 'flex' : 'none';
                }

                // 색상 패널 모드 표시
                const modeBadge = document.querySelector('.mode-badge');
                if (modeBadge) {
                    if (currentMode === 'click') {
                        modeBadge.textContent = '클릭 모드';
                        modeBadge.style.display = 'inline-block';
                    } else {
                        modeBadge.style.display = 'none';
                    }
                }
            });
        });
    </script>

    <!-- 백업 목록 모달 -->
    <div id="backupModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>백업 관리</h2>
                <span class="close" onclick="closeBackupModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="backup-modal-actions">
                    <button onclick="runManualBackup()" class="backup-action-btn">
                        💾 수동 백업 실행
                    </button>
                </div>
                <hr style="margin: 20px 0;">
                <h3>백업 목록</h3>
                <div id="backupList">
                    <!-- 백업 목록이 여기 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 백업 관련 함수들
        function showBackupModal() {
            document.getElementById('backupModal').style.display = 'block';
            loadBackupList();
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        // 수동 백업 실행 (Excel 다운로드)
        async function runManualBackup() {
            if (confirm('Excel 파일로 백업을 다운로드하시겠습니까?')) {
                try {
                    if (window.UnifiedBackupManager) {
                        await window.UnifiedBackupManager.downloadExcel();
                    } else {
                        alert('백업 매니저를 찾을 수 없습니다.');
                    }
                } catch (error) {
                    console.error('백업 다운로드 실패:', error);
                    alert('백업 다운로드에 실패했습니다.');
                }
            }
        }

        // TODO(human)
        // 로그아웃 처리 함수
        function handleLogout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                // 세션 정보 삭제
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userInfo');
                localStorage.removeItem('authProvider');
                localStorage.removeItem('loginToken');
                localStorage.removeItem('tokenExpiry');
                localStorage.removeItem('devLoginToken');
                localStorage.removeItem('devLoginExpiry');

                // 구글 관련 토큰도 정리 (있을 경우)
                localStorage.removeItem('googleToken');
                localStorage.removeItem('accessToken');

                // 로그인 페이지로 이동
                window.location.href = '/login.html';
            }
        }

        async function loadBackupList() {
            const listContainer = document.getElementById('backupList');

            // 새로운 백업 시스템 상태 표시
            const status = window.UnifiedBackupManager?.getStatus();

            let html = '<div class="backup-status">';
            html += '<h4>백업 시스템 상태</h4>';
            html += `<p>🌐 온라인: ${status?.isOnline ? '✅' : '❌'}</p>`;
            html += `<p>☁️ Supabase: ${status?.supabaseConnected ? '✅ 연결됨' : '❌ 연결 안됨'}</p>`;

            if (status?.cache) {
                const cacheAge = Math.floor((Date.now() - status.cache.timestamp) / 1000 / 60);
                html += `<p>💾 로컬 캐시: ${status.cache.count}개 필지 (${cacheAge}분 전)</p>`;
            }

            if (status?.pendingSyncCount > 0) {
                html += `<p>⏳ 동기화 대기: ${status.pendingSyncCount}개</p>`;
            }

            html += '</div>';
            html += '<hr style="margin: 20px 0;">';
            html += '<h4>백업 안내</h4>';
            html += '<ul style="text-align: left; padding-left: 20px;">';
            html += '<li>☁️ <strong>자동 백업:</strong> 매일 새벽 2시 Supabase Storage에 자동 저장</li>';
            html += '<li>📥 <strong>수동 백업:</strong> 위 "수동 백업 실행" 버튼으로 Excel 다운로드</li>';
            html += '<li>💾 <strong>실시간 저장:</strong> 모든 변경사항이 Supabase에 즉시 저장됨</li>';
            html += '<li>👥 <strong>팀 협업:</strong> 다른 사용자의 변경사항이 실시간으로 동기화됨</li>';
            html += '</ul>';

            listContainer.innerHTML = html;
        }

        // 백업 복원 (현재는 Excel 업로드 기능 없음)
        async function restoreBackup(backupDate) {
            alert('현재 Excel 업로드 복원 기능은 지원하지 않습니다.\nSupabase에서 자동 백업이 관리됩니다.');
        }

        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('backupModal');
            if (event.target === modal) {
                closeBackupModal();
            }
        }
    </script>

</body>
</html>
