<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <title>NAVER Maps Field Management Program</title>
    
    <!-- ë„¤ì´ë²„ ì§€ë„ API -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=xzbnwd2h1z&submodules=geocoder,panorama"></script>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- html2canvas for screenshot capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/advanced-ui.css">
    <link rel="stylesheet" href="/css/business-style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/backup-ui.css">
    <link rel="stylesheet" href="/css/modes.css">
</head>
<body>
    <div id="app">
        <!-- í—¤ë” ì˜ì—­ -->
        <header class="header">
            <div class="header-left">
                <h1 style="color: white;">ë„¤ì´ë²„ ì§€ë„ í•„ì§€ ê´€ë¦¬ í”„ë¡œê·¸ë¨</h1>
            </div>
            <div class="header-center">
                <!-- ì§€ë„ íƒ€ì… ì„ íƒ -->
                <div class="map-type-selector">
                    <button class="map-type-btn active" data-type="normal">ì¼ë°˜ì§€ë„</button>
                    <button class="map-type-btn" data-type="satellite">ìœ„ì„±ì§€ë„</button>
                    <button class="map-type-btn" data-type="cadastral">ì§€ì í¸ì§‘ë„</button>
                    <button class="map-type-btn" data-type="street">ê±°ë¦¬ë·°</button>
                </div>
            </div>
            <div class="header-right">
                <div id="connectionStatus" class="connection-status disconnected">ğŸ”´ ì—°ê²° ì¤‘...</div>


            </div>
        </header>

        <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
        <div class="main-container">
            <!-- ì‚¬ì´ë“œë°” -->
            <aside class="sidebar">
            <!-- ìƒ‰ìƒ ì„ íƒ íŒ¨ë„ -->
            <div class="color-panel">
                <h3>í•„ì§€ ìƒ‰ìƒ <span class="mode-badge">í´ë¦­ ëª¨ë“œ</span></h3>
                <div class="color-palette" id="colorPalette">
                    <div class="color-item active" data-color="0" data-hex="#FF0000" style="background: #FF0000" title="ë¹¨ê°•"></div>
                    <div class="color-item" data-color="1" data-hex="#FFA500" style="background: #FFA500" title="ì£¼í™©"></div>
                    <div class="color-item" data-color="2" data-hex="#FFFF00" style="background: #FFFF00" title="ë…¸ë‘"></div>
                    <div class="color-item" data-color="3" data-hex="#90EE90" style="background: #90EE90" title="ì—°ë‘"></div>
                    <div class="color-item" data-color="4" data-hex="#0000FF" style="background: #0000FF" title="íŒŒë‘"></div>
                    <div class="color-item" data-color="5" data-hex="#000000" style="background: #000000" title="ê²€ì •"></div>
                    <div class="color-item" data-color="6" data-hex="#FFFFFF" style="background: #FFFFFF; border: 1px solid #ccc" title="í°ìƒ‰"></div>
                    <div class="color-item" data-color="7" data-hex="#87CEEB" style="background: #87CEEB" title="í•˜ëŠ˜ìƒ‰"></div>
                </div>
                <div class="current-color">
                    <span>ì„ íƒëœ ìƒ‰ìƒ:</span>
                    <div id="currentColor" style="background: #FF0000"></div>
                </div>
                <div class="color-stats">
                    <span id="colorStats">ì´ 0ê°œ í•„ì§€</span>
                </div>
            </div>

            <!-- í•„ì§€ ì •ë³´ ì…ë ¥ -->
            <div class="parcel-info">
                <h3>í•„ì§€ ì •ë³´</h3>
                <form id="parcelForm">
                    <div class="form-group">
                        <label>ì§€ë²ˆ</label>
                        <input type="text" id="parcelNumber" placeholder="ì˜ˆ: 123-4">
                    </div>
                    <div class="form-group">
                        <label>ì†Œìœ ì ì´ë¦„</label>
                        <input type="text" id="ownerName" placeholder="í™ê¸¸ë™">
                    </div>
                    <div class="form-group">
                        <label>ì†Œìœ ì ì£¼ì†Œ</label>
                        <input type="text" id="ownerAddress" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬...">
                    </div>
                    <div class="form-group">
                        <label>ì—°ë½ì²˜</label>
                        <input type="text" id="ownerContact" placeholder="010-1234-5678">
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <textarea id="memo" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨..." style="resize: vertical; min-height: 60px;"></textarea>
                    </div>
                    <div class="form-buttons">
                        <button type="button" id="saveParcelInfoBtn" class="btn-save">
                            ğŸ“ í•„ì§€ ì •ë³´ ì €ì¥
                        </button>
                        <button type="button" id="deleteParcelInfoBtn" class="btn-delete">
                            ğŸ—‘ï¸ í•„ì§€ ì •ë³´ ì‚­ì œ
                        </button>
                        <button type="button" id="copyToClipboardBtn" class="btn-copy">
                            ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬
                        </button>
                    </div>
                </form>
            </div>

            <!-- ì‚¬ì´ë“œë°” í•˜ë‹¨ ë²„íŠ¼ë“¤ -->
            <div class="sidebar-bottom-buttons">
                <!-- ìº˜ë¦°ë” ë²„íŠ¼ -->
                <button id="calendarBtn" class="sidebar-btn calendar-btn" onclick="openCalendarModal()" title="ì—…ë¬´ ìº˜ë¦°ë”">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                        <line x1="3" y1="9" x2="21" y2="9" stroke="currentColor" stroke-width="2"/>
                        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <rect x="7" y="12" width="3" height="3" rx="0.5" fill="currentColor"/>
                        <rect x="14" y="12" width="3" height="3" rx="0.5" fill="currentColor"/>
                        <rect x="7" y="17" width="3" height="3" rx="0.5" fill="currentColor"/>
                    </svg>
                    <span>ìº˜ë¦°ë”</span>
                </button>

                <!-- ë°±ì—… ê´€ë¦¬ ë²„íŠ¼ -->
                <button id="backupBtn" class="sidebar-btn backup-btn" onclick="showBackupModal()" title="ë°±ì—… ê´€ë¦¬">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2"/>
                        <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2"/>
                        <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2"/>
                        <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2"/>
                        <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span>ë°±ì—…</span>
                </button>
            </div>

            </aside>

            <!-- ì§€ë„ ì˜ì—­ -->
            <div class="map-container">
                <!-- ëª¨ë“œ ì „í™˜ ë²„íŠ¼ -->
                <div class="mode-switcher">
                    <button class="mode-button active" data-mode="click">í´ë¦­</button>
                    <button class="mode-button" data-mode="search">ğŸ” ê²€ìƒ‰</button>
                    <button class="mode-button" data-mode="hand">ì†</button>
                </div>

                <!-- ëª¨ë“œ ì¸ë””ì¼€ì´í„° -->
                <div class="mode-indicator">í´ë¦­ ëª¨ë“œ</div>

                <!-- ê²€ìƒ‰ ì…ë ¥ (ê²€ìƒ‰ ëª¨ë“œ ì „ìš©) -->
                <div class="search-input-container search-only" style="display:none;">
                    <input type="text" id="searchInput" placeholder="ì§€ë²ˆ ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰">
                    <button id="searchBtn">ê²€ìƒ‰</button>
                </div>

                <!-- ê²€ìƒ‰ ê²°ê³¼ (ì œê±°ë¨ - ì‚¬ìš©ì ìš”ì²­) -->
                <!-- <div class="search-results-container search-only" style="display:none;">
                    <div class="search-results-header">ê²€ìƒ‰ ê²°ê³¼</div>
                    <div id="searchResults" class="search-results-body"></div>
                </div> -->

                <!-- ëª¨ë“œë³„ ë…ë¦½ ì§€ë„ ì¸ìŠ¤í„´ìŠ¤ -->
                <div id="map-click" class="map-instance active"></div>
                <div id="map-search" class="map-instance" style="display:none;"></div>
                <div id="map-hand" class="map-instance" style="display:none;"></div>

                <!-- ê±°ë¦¬ë·° (ëª¨ë“  ëª¨ë“œ ê³µìš©) -->
                <div id="pano" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <!-- ìº˜ë¦°ë” ëª¨ë‹¬ -->
    <div id="calendarModal" class="modal" style="display: none;">
        <div class="modal-content calendar-modal">
            <div class="modal-header">
                <h2>ì—…ë¬´ ìº˜ë¦°ë”</h2>
                <span class="close" onclick="closeCalendarModal()">&times;</span>
            </div>
            <div class="modal-body">
                <iframe id="calendarIframe" 
                        src="https://calendar.google.com/calendar/embed?height=600&wkst=2&bgcolor=%23ffffff&ctz=Asia%2FSeoul&showTitle=0&showNav=1&showDate=1&showPrint=0&showTabs=1&showCalendars=1&showTz=0&mode=MONTH&src=ko.south_korea%23holiday%40group.v.calendar.google.com&color=%230B8043" 
                        style="border: 0; width: 100%; height: 500px;" 
                        frameborder="0" 
                        scrolling="yes">
                </iframe>
            </div>
            <div class="modal-footer">
                <input type="text" id="calendarUrl" placeholder="êµ¬ê¸€ ìº˜ë¦°ë” URL ë˜ëŠ” ì´ë©”ì¼">
                <button onclick="updateCalendar()" class="btn-primary">ì ìš©</button>
                <button onclick="closeCalendarModal()" class="btn-secondary">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    

    <!-- JavaScript -->
    <script src="/js/log-config.js"></script>
    <script src="/js/config-client.js"></script>
    <script src="/js/supabase-config.js"></script>
    <script src="/js/supabase-adapter.js"></script>
    <script src="/js/realtime-sync.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/calendar.js"></script>
    <script src="/js/map.js"></script>
    <script src="/js/mode-click-handler.js"></script>
    <script src="/js/mode-search-handler.js"></script>
    <script src="/js/map-instances.js"></script>
    <script src="/js/parcel.js"></script>
    <script src="/js/parcel-manager.js"></script>
    <script src="/js/mode-manager.js"></script>
    <script src="/js/color-palette.js"></script>
    <script src="/js/search-mode.js"></script>
    <script src="/js/search.js"></script>
    <script src="/js/memo-markers.js"></script>
    <script src="/js/backup-manager.js"></script>
    <script src="/js/sheets.js"></script>
    <script src="/js/mobile-handler.js"></script>
    <!-- data-persistence-manager.js ë¹„í™œì„±í™” - LocalStorageì™€ Supabaseë§Œ ì‚¬ìš© -->
    <!-- <script src="/js/data-persistence-manager.js"></script> -->
    <script src="/js/parcel-restore-helper.js"></script>
    <script src="/js/advanced-backup-manager.js"></script>
    <script src="/js/backup-ui.js"></script>
    <script src="/js/realtime-autosave.js"></script>
    <script src="/js/debug-save-system.js"></script>
    <script src="/js/app-init.js"></script>
    <script>
        // ëª¨ë“œ ì „í™˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', function() {
            // ëª¨ë“œ ì „í™˜ ë²„íŠ¼
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.mode;

                    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
                    modeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // ëª¨ë“œ ì „í™˜
                    if (window.ModeManager) {
                        window.ModeManager.switchMode(mode);
                    }
                });
            });

            // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ìë™ ëª¨ë“œ ì „í™˜
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');

            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    const query = searchInput.value.trim();
                    if (query && window.SearchModeManager) {
                        window.SearchModeManager.executeSearch(query, 'all');
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const query = this.value.trim();
                        if (query && window.SearchModeManager) {
                            window.SearchModeManager.executeSearch(query, 'all');
                        }
                    }
                });
            }

            // ê²€ìƒ‰ ì´ˆê¸°í™” ë²„íŠ¼
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    if (window.SearchModeManager) {
                        window.SearchModeManager.clearSearch();
                    }
                });
            }

            // ëª¨ë“œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            window.addEventListener('modeChanged', function(e) {
                const { currentMode } = e.detail;

                // ê²€ìƒ‰ ëª¨ë“œ ì¸ë””ì¼€ì´í„° í‘œì‹œ/ìˆ¨ê¹€
                const searchIndicator = document.querySelector('.search-mode-indicator');
                if (searchIndicator) {
                    searchIndicator.style.display = currentMode === 'search' ? 'flex' : 'none';
                }

                // ìƒ‰ìƒ íŒ¨ë„ ëª¨ë“œ í‘œì‹œ
                const modeBadge = document.querySelector('.mode-badge');
                if (modeBadge) {
                    if (currentMode === 'click') {
                        modeBadge.textContent = 'í´ë¦­ ëª¨ë“œ';
                        modeBadge.style.display = 'inline-block';
                    } else {
                        modeBadge.style.display = 'none';
                    }
                }
            });
        });
    </script>

    <!-- ë°±ì—… ëª©ë¡ ëª¨ë‹¬ -->
    <div id="backupModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ë°±ì—… ê´€ë¦¬</h2>
                <span class="close" onclick="closeBackupModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="backup-modal-actions">
                    <button onclick="runManualBackup()" class="backup-action-btn">
                        ğŸ’¾ ìˆ˜ë™ ë°±ì—… ì‹¤í–‰
                    </button>
                    <button onclick="exportToGoogleSheets()" class="backup-action-btn">
                        ğŸ“Š Google Sheetsë¡œ ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
                <hr style="margin: 20px 0;">
                <h3>ë°±ì—… ëª©ë¡</h3>
                <div id="backupList">
                    <!-- ë°±ì—… ëª©ë¡ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë°±ì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showBackupModal() {
            document.getElementById('backupModal').style.display = 'block';
            loadBackupList();
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        // ìˆ˜ë™ ë°±ì—… ì‹¤í–‰
        async function runManualBackup() {
            if (confirm('ìˆ˜ë™ ë°±ì—…ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const result = await window.BackupManager.runManualBackup('daily');
                    if (result && result.success) {
                        alert('ë°±ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadBackupList(); // ë°±ì—… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else if (result) {
                        alert('ë°±ì—… ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    } else {
                        // resultê°€ undefinedì¸ ê²½ìš°ì—ë„ ì²˜ë¦¬
                        loadBackupList(); // ë°±ì—… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    }
                } catch (error) {
                    console.error('ë°±ì—… ì‹¤í–‰ ì‹¤íŒ¨:', error);
                    alert('ë°±ì—… ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // Google Sheetsë¡œ ë‚´ë³´ë‚´ê¸°
        async function exportToGoogleSheets() {
            if (confirm('Google Sheetsë¡œ ë°ì´í„°ë¥¼ ë‚´ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const result = await window.BackupManager.exportToGoogleSheets();
                    if (result.success) {
                        alert('Google Sheetsë¡œ ì„±ê³µì ìœ¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.\n' + result.spreadsheetUrl);
                    } else {
                        alert('Google Sheets ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('Google Sheets ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
                    alert('Google Sheets ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        async function loadBackupList() {
            const listContainer = document.getElementById('backupList');
            listContainer.innerHTML = '<p>ë°±ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

            try {
                const backups = await window.BackupManager.getBackupList();

                if (backups.length === 0) {
                    listContainer.innerHTML = '<p>ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = '<table class="backup-table">';
                html += '<thead><tr><th>ë‚ ì§œ</th><th>í•„ì§€ ìˆ˜</th><th>í¬ê¸°</th><th>ì†ŒìŠ¤</th><th>ì‘ì—…</th></tr></thead>';
                html += '<tbody>';

                backups.forEach(backup => {
                    const date = new Date(backup.date).toLocaleString('ko-KR');
                    const size = (backup.size / 1024).toFixed(2) + ' KB';
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${backup.count}ê°œ</td>
                            <td>${size}</td>
                            <td>${backup.source}</td>
                            <td>
                                <button class="btn-restore" onclick="restoreBackup('${backup.date}')">ë³µì›</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                listContainer.innerHTML = html;
            } catch (error) {
                listContainer.innerHTML = '<p>ë°±ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                console.error('ë°±ì—… ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function restoreBackup(backupDate) {
            if (confirm('ì •ë§ë¡œ ì´ ë°±ì—…ì„ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë°±ì—…ë©ë‹ˆë‹¤.')) {
                await window.BackupManager.restoreFromBackup(backupDate);
                closeBackupModal();
            }
        }

        // ë°±ì—… ìƒíƒœ ì—…ë°ì´íŠ¸ (í—¤ë”ìš©)
        document.addEventListener('DOMContentLoaded', function() {
            // ë°±ì—… ìƒíƒœ ì—…ë°ì´íŠ¸ - í—¤ë” ë°±ì—… ë²„íŠ¼ê³¼ ì—°ë™
            updateBackupStatus();
            setInterval(updateBackupStatus, 60000); // 1ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸
        });

        function updateBackupStatus() {
            const status = window.BackupManager?.getBackupStatus();
            if (status && status.lastDaily) {
                const lastBackupTime = document.getElementById('lastBackupTime');
                if (lastBackupTime) {
                    const date = new Date(status.lastDaily);
                    lastBackupTime.textContent = date.toLocaleString('ko-KR');
                }
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('backupModal');
            if (event.target === modal) {
                closeBackupModal();
            }
        }
    </script>
    <script src="/js/debug-save.js"></script>
    <script src="/js/fix-marker-issue.js"></script>

</body>
</html>