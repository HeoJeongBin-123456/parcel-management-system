<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 지도 필지 관리 - 로그인</title>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #e8f5e8 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .login-container {
            background: white;
            border: 1px solid #03c75a;
            border-top: 3px solid #03c75a;
            padding: 2.5rem;
            box-shadow: 0 4px 12px rgba(3,199,90,0.15);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }
        
        .logo {
            margin-bottom: 2rem;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            color: #03c75a;
            margin-bottom: 0.3rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        .logo p {
            color: #666;
            font-size: 0.85rem;
        }
        
        .features {
            text-align: left;
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f9fdf9;
            border: 1px solid #d4ecd4;
            border-left: 3px solid #03c75a;
        }
        
        .features h3 {
            font-size: 0.9rem;
            color: #03c75a;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }
        
        .features ul {
            list-style: none;
        }
        
        .features li {
            padding: 0.4rem 0;
            color: #555;
            font-size: 0.85rem;
        }
        
        .features li:before {
            content: "• ";
            margin-right: 0.5rem;
            color: #2c5282;
        }
        
        #googleSignInButton {
            margin: 2rem 0;
            display: flex;
            justify-content: center;
        }
        
        
        .loading {
            display: none;
            margin: 2rem 0;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            display: none;
            color: #e74c3c;
            margin-top: 1rem;
            padding: 1rem;
            background: #fee;
            border-radius: 5px;
            font-size: 0.875rem;
        }
        
        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <h1>네이버 지도 필지 관리 프로그램</h1>
        </div>
        
        <div class="features">
            <h3>구글 계정 로그인</h3>
            <ul>
                <li>구글 시트에 자동으로 데이터 저장</li>
                <li>구글 캘린더 자동 연동</li>
                <li>어디서나 데이터 접근 가능</li>
                <li>보안된 데이터 관리</li>
            </ul>
        </div>
        
        <!-- 구글 로그인 버튼 -->
        <div id="googleSignInButton"></div>
        
        <div class="loading" id="loadingSpinner">
            <div class="spinner"></div>
            <p style="margin-top: 1rem; color: #6c757d;">로그인 처리중...</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
    </div>
    
    <script>
        // Google OAuth Client ID (사용자가 설정해야 함)
        const CLIENT_ID = '506368463001-um0b25os2vlep7mumonf63pcm9c9a0n3.apps.googleusercontent.com';
        
        // 필요한 권한 스코프
        const SCOPES = [
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/calendar.readonly',
            'https://www.googleapis.com/auth/userinfo.profile',
            'https://www.googleapis.com/auth/userinfo.email'
        ].join(' ');
        
        
        // 구글 로그인 성공 콜백
        function handleCredentialResponse(response) {
            console.log('로그인 성공');
            document.getElementById('loadingSpinner').classList.add('show');
            
            // JWT 토큰 저장 (localStorage 사용하여 세션 유지)
            localStorage.setItem('googleToken', response.credential);
            
            // 사용자 정보 파싱 (JWT 디코드)
            const userInfo = parseJwt(response.credential);
            localStorage.setItem('userInfo', JSON.stringify(userInfo));
            
            // ID 토큰 만료 시간 설정 (보통 1시간)
            const expiryTime = new Date().getTime() + (60 * 60 * 1000); // 1시간
            localStorage.setItem('tokenExpiry', expiryTime.toString());
            console.log('토큰 만료 시간 설정:', new Date(expiryTime));
            
            // Sheets/Calendar API가 필요하지 않으면 바로 메인 페이지로 이동
            // 필요시에만 액세스 토큰 요청
            setTimeout(() => {
                window.location.href = '/index.html';
            }, 500);
        }
        
        // JWT 토큰 파싱
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        // OAuth 2.0 액세스 토큰 요청
        function requestAccessToken() {
            // Google Identity Services의 토큰 클라이언트 초기화
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    console.log('액세스 토큰 획득 성공');
                    // localStorage에 토큰 저장 및 만료 시간 설정
                    localStorage.setItem('accessToken', tokenResponse.access_token);
                    const expiryTime = new Date().getTime() + (tokenResponse.expires_in || 3600) * 1000;
                    localStorage.setItem('tokenExpiry', expiryTime.toString());
                    
                    // 메인 페이지로 이동
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 500);
                },
                error_callback: (error) => {
                    console.error('액세스 토큰 획득 실패:', error);
                    showError('권한 승인에 실패했습니다. 다시 시도해주세요.');
                }
            });
            
            // 토큰 요청
            tokenClient.requestAccessToken();
        }
        
        // 에러 메시지 표시
        function showError(message) {
            document.getElementById('loadingSpinner').classList.remove('show');
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        
        // 페이지 로드 시 Google Identity Services 초기화
        window.onload = function() {
            
            // Google Sign-In 초기화
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true
            });
            
            // 로그인 버튼 렌더링
            google.accounts.id.renderButton(
                document.getElementById("googleSignInButton"),
                { 
                    theme: "outline",
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    logo_alignment: "left"
                }
            );
        };
    </script>
</body>
</html>